; PlatformIO Project Configuration File
;
;   Build options: build flags, source filter
;   Upload options: custom upload port, speed and extra flags
;   Library options: dependencies, extra library storages
;   Advanced options: extra scripting
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html

[env:esp32-s3-devkitc-1]
platform = espressif32@6.12.0
board = esp32-s3-devkitc-1
framework = arduino
board_build.flash_mode = qio
board_build.flash_size = 16MB
board_build.psram_mode = octal
; Auto-generate version header before build
extra_scripts = pre:generate_version_header.py
; Minimal phase: only build display + hal + core
build_src_filter = 
    -<*>
    +<main.cpp>
    +<display/**>
    +<hal/**>
    +<sensors/**>
    +<controllers/**>
    +<rtos/**>
    +<utils/**>

; Serial port settings
monitor_speed = 115200
monitor_filters = esp32_exception_decoder

; Critical build flags for Waveshare ESP32-S3-Touch-LCD-4.3B
build_flags = 
    -DBOARD_HAS_PSRAM
    -DCONFIG_SPIRAM_SUPPORT=1
    -DCONFIG_SPIRAM_CACHE_WORKAROUND=1
    -DCONFIG_SPIRAM_ALLOW_STACK_EXTERNAL_MEMORY=1
    
    ; LVGL Configuration
    -DLV_CONF_INCLUDE_SIMPLE
    -DLV_TICK_PERIOD_MS=5
    
    ; Pin Definitions for Waveshare Type B
    -DDISPLAY_DE_PIN=5
    -DDISPLAY_VSYNC_PIN=3
    -DDISPLAY_HSYNC_PIN=46
    -DDISPLAY_PCLK_PIN=7
    -DI2C_SDA_PIN=8
    -DI2C_SCL_PIN=9
    -DTOUCH_IRQ_PIN=4
    -DDS18B20_PIN=33
    
    ; Feature Flags (uncomment to enable)
    ; -DENABLE_RGB_PANEL     ; Enable real RGB bus (LovyanGFX Bus_RGB)
    ; -DENABLE_TOUCH         ; Explicitly define to force touch (default assumed ON)
    ; -DENABLE_DHT        ; Uncomment when sensor stack (DHT) restored
    ; -DENABLE_DS18B20
    ; -DENABLE_CAN
    ; -DENABLE_RS485

    ; Debug
    -DDEBUG_MODE
    -DCORE_DEBUG_LEVEL=3
    ; Version header will produce FW_VERSION_GIT / FW_VERSION_SHORT macros
    -include include/version.h

lib_deps =
    lvgl/lvgl@8.3.11
    lovyan03/LovyanGFX@^1.1.16
    paulstoffregen/OneWire@^2.3.8
    milesburton/DallasTemperature@^3.11.0
    ; --- Sensors & JSON (disabled during minimal display bring-up) ---
    ; OneWire
    ; DallasTemperature
    ; ArduinoJson@7.4.2
    ; adafruit/Adafruit Unified Sensor@1.1.15
    ; adafruit/DHT sensor library@^1.4.6

; Local libraries folder containing critical libraries
lib_extra_dirs =
    lib

; Custom partition to fit in 16MB flash
board_build.partitions = partitions.csv

; Enable warnings during compilation
build_type = release

[env:native]
platform = native
build_flags =
    -DUNIT_TEST
    -DUNIT_TEST_NATIVE
test_filter = native
build_src_filter = 
    -<*>
; Ignore hardware-dependent test bundles; use only native/test_logic.cpp
test_ignore = test_main.cpp, test_system_utils.cpp, test_temperature_controller_faults.cpp